{{ define "main" }}

{{/* =========================================================
   Layer 1 (clean version):
   Photo path auto-built from slugs:
   external-ssd/{brand_slug}/{model_slug}/{capacity_slug}/unit.webp
   ========================================================= */}}

{{/* 1) imgBase from config */}}
{{ $imgBase := or .Site.Params.imgBase "https://eugen-standard.pages.dev" }}
{{ $imgBase = strings.TrimSuffix "/" $imgBase }}

{{/* 2) Build photo path from slugs */}}
{{ $brand := .Params.brand_slug }}
{{ $model := .Params.model_slug }}
{{ $capacity := .Params.capacity_slug }}

{{ $photoURL := "" }}
{{ if and $brand $model $capacity }}
  {{ $photoURL = printf "%s/external-ssd/%s/%s/%s/unit.webp" $imgBase $brand $model $capacity }}
{{ end }}

{{/* 3) Work with rendered HTML */}}
{{ $c := .Content }}

{{ $pattern := `(?s)^(.*?)(<h2>Test unit (?:&amp;|&) environment</h2>\s*<table class="meta-table".*?</table>)(.*)$` }}
{{ $hasTestUnit := and (in $c "meta-table") (or (in $c "Test unit &amp; environment") (in $c "Test unit & environment")) }}

<article class="data-page">

  <header class="page-header">
    <h1>{{ .Title }}</h1>

    {{/* Capacity switch (same series: 500GB/1TB/2TB) */}}
    {{ $cap := path.Base (strings.TrimSuffix "/" .RelPermalink) }}
    {{ $seriesBase := replaceRE `(500gb|1tb|2tb)/$` "" .RelPermalink }}
    {{ $seriesPath := strings.TrimPrefix .Site.LanguagePrefix $seriesBase }}

    {{ $p500 := .Site.GetPage (printf "%s500gb" $seriesPath) }}
    {{ $p1   := .Site.GetPage (printf "%s1tb"   $seriesPath) }}
    {{ $p2   := .Site.GetPage (printf "%s2tb"   $seriesPath) }}

    {{ $has500 := and $p500 (eq $p500.Kind "page") }}
    {{ $has1   := and $p1   (eq $p1.Kind "page") }}
    {{ $has2   := and $p2   (eq $p2.Kind "page") }}

    {{ $show500 := or (eq $cap "500gb") $has500 }}
    {{ $show1   := or (eq $cap "1tb")   $has1 }}
    {{ $show2   := or (eq $cap "2tb")   $has2 }}

    {{ if or $show500 $show1 $show2 }}
      <nav class="cap-switch" aria-label="Capacity switch">
        {{ if $show500 }}
          <a class="cap-btn {{ if eq $cap "500gb" }}is-active{{ end }}" href="{{ $seriesBase }}500gb/">500GB</a>
        {{ end }}
        {{ if $show1 }}
          <a class="cap-btn {{ if eq $cap "1tb" }}is-active{{ end }}" href="{{ $seriesBase }}1tb/">1TB</a>
        {{ end }}
        {{ if $show2 }}
          <a class="cap-btn {{ if eq $cap "2tb" }}is-active{{ end }}" href="{{ $seriesBase }}2tb/">2TB</a>
        {{ end }}
      </nav>
    {{ end }}

    {{/* Lead text:
        - prefer .Params.lead (markdown, linkable)
        - fallback to .Params.description
    */}}
    {{ with .Params.lead }}
      <p class="lead">{{ . | $.Page.RenderString }}</p>
    {{ else }}
      {{ with .Params.description }}
        <p class="lead">{{ . | $.Page.RenderString }}</p>
      {{ end }}
    {{ end }}
  </header>

  <section class="content">

    {{ if and $hasTestUnit $brand $model $capacity }}

      {{ $before := replaceRE $pattern "$1" $c }}
      {{ $block  := replaceRE $pattern "$2" $c }}
      {{ $after  := replaceRE $pattern "$3" $c }}

      {{ $h2 := replaceRE `(?s)^((?:<h2>.*?</h2>)).*` "$1" $block }}
      {{ $table := replaceRE `(?s)^<h2>.*?</h2>\s*` "" $block }}

      {{ $before | safeHTML }}
      {{ $h2 | safeHTML }}

      <div class="testunit-grid">
        <div class="testunit-left">
          {{ $table | safeHTML }}
        </div>

        <div class="testunit-right">
          <figure class="testunit-photo">
            <img
              class="testunit-photo-img"
              src="{{ $photoURL }}"
              onerror="this.closest('.testunit-right').style.display='none';"
              alt="{{ .Title }} - test unit photo"
              loading="lazy"
              decoding="async">
          </figure>
        </div>
      </div>

      {{ $after | safeHTML }}

    {{ else }}

      {{ .Content }}

    {{ end }}

  </section>

  <footer class="meta">
    {{ with .Lastmod }}
      <p class="small muted">Last updated: {{ .Format "2006-01-02" }}</p>
    {{ end }}
  </footer>

</article>

{{ end }}