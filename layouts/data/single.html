{{ define "main" }}

{{/* =========================================================
   Layer 1 (clean, i18n-safe):
   - No dependence on English text inside .Content
   - Content stores only keys in data-* attributes
   - We render translated labels via i18n here
   ========================================================= */}}

{{/* 1) imgBase from config */}}
{{ $imgBase := or .Site.Params.imgBase "https://eugen-standard.pages.dev" }}
{{ $imgBase = strings.TrimSuffix "/" $imgBase }}

{{/* 2) Build photo path from slugs */}}
{{ $brand := .Params.brand_slug }}
{{ $model := .Params.model_slug }}
{{ $capacity := .Params.capacity_slug }}

{{ $photoURL := "" }}
{{ if and $brand $model $capacity }}
  {{ $photoURL = printf "%s/external-ssd/%s/%s/%s/unit.webp" $imgBase $brand $model $capacity }}
{{ end }}

{{/* 3) Work with rendered HTML */}}
{{ $c := .Content }}

{{/* Find first meta-table anywhere */}}
{{ $metaRe := `(?s)<table class="meta-table".*?</table>` }}
{{ $metaMatches := findRE $metaRe $c 1 }}
{{ $hasMeta := gt (len $metaMatches) 0 }}
{{ $metaTable := "" }}
{{ if $hasMeta }}
  {{ $metaTable = index $metaMatches 0 }}
{{ end }}

{{/* Remove optional <h2> right before meta-table + the meta-table itself (first occurrence only) */}}
{{ $removeMetaBlockRe := `(?s)<h2>.*?</h2>\s*<table class="meta-table".*?</table>|<table class="meta-table".*?</table>` }}
{{ $rest := $c }}
{{ if $hasMeta }}
  {{ $rest = replaceRE $removeMetaBlockRe "" $c 1 }}
{{ end }}

<article class="data-page">

  <header class="page-header">
    <h1>{{ .Title }}</h1>

    {{/* Capacity switch (same series: 500GB/1TB/2TB) */}}
    {{ $cap := path.Base (strings.TrimSuffix "/" .RelPermalink) }}
    {{ $seriesBase := replaceRE `(500gb|1tb|2tb)/$` "" .RelPermalink }}
    {{ $seriesPath := strings.TrimPrefix .Site.LanguagePrefix $seriesBase }}

    {{ $p500 := .Site.GetPage (printf "%s500gb" $seriesPath) }}
    {{ $p1   := .Site.GetPage (printf "%s1tb"   $seriesPath) }}
    {{ $p2   := .Site.GetPage (printf "%s2tb"   $seriesPath) }}

    {{ $has500 := and $p500 (eq $p500.Kind "page") }}
    {{ $has1   := and $p1   (eq $p1.Kind "page") }}
    {{ $has2   := and $p2   (eq $p2.Kind "page") }}

    {{ $show500 := or (eq $cap "500gb") $has500 }}
    {{ $show1   := or (eq $cap "1tb")   $has1 }}
    {{ $show2   := or (eq $cap "2tb")   $has2 }}

    {{ if or $show500 $show1 $show2 }}
      <nav class="cap-switch" aria-label="{{ i18n "data_capacity_switch" }}">
        {{ if $show500 }}
          <a class="cap-btn {{ if eq $cap "500gb" }}is-active{{ end }}" href="{{ $seriesBase }}500gb/">500GB</a>
        {{ end }}
        {{ if $show1 }}
          <a class="cap-btn {{ if eq $cap "1tb" }}is-active{{ end }}" href="{{ $seriesBase }}1tb/">1TB</a>
        {{ end }}
        {{ if $show2 }}
          <a class="cap-btn {{ if eq $cap "2tb" }}is-active{{ end }}" href="{{ $seriesBase }}2tb/">2TB</a>
        {{ end }}
      </nav>
    {{ end }}

    {{/* Lead text */}}
    {{ with .Params.lead }}
      <p class="lead">{{ . | $.Page.RenderString }}</p>
    {{ else }}
      {{ with .Params.description }}
        <p class="lead">{{ . | $.Page.RenderString }}</p>
      {{ end }}
    {{ end }}
  </header>

  <section class="content">

    {{ if $hasMeta }}

      <h2>{{ i18n "data_test_unit_env" }}</h2>

      <div class="testunit-grid">
        <div class="testunit-left">

          {{/* Translate meta labels: <th data-meta="x"></th> → <th>i18n</th> */}}
          {{ $mt := $metaTable }}

          {{ $metaKeys := findRE `data-meta="([^"]+)"` $mt 999 }}
          {{ $metaSeen := dict }}

          {{ range $metaKeys }}
            {{ $k := replaceRE `^data-meta="([^"]+)".*$` `$1` . }}
            {{ if not (index $metaSeen $k) }}
              {{ $metaSeen = merge $metaSeen (dict $k true) }}
              {{ $from := printf `<th data-meta="%s"></th>` $k }}
              {{ $to := printf `<th>%s</th>` (i18n (printf "data_meta_%s" $k)) }}
              {{ $mt = replaceRE $from $to $mt }}
            {{ end }}
          {{ end }}

          {{ $mt | safeHTML }}

        </div>

        <div class="testunit-right">
          <figure class="testunit-photo">
            <img
              class="testunit-photo-img"
              src="{{ $photoURL }}"
              onerror="this.closest('.testunit-right').style.display='none';"
              alt="{{ i18n "data_test_unit_photo" }}"
              loading="lazy"
              decoding="async">
          </figure>
        </div>
      </div>

      {{/* Find all data tables */}}
      {{ $tables := findRE `(?s)<table class="data-table"[^>]*data-test="[^"]+"[^>]*>.*?</table>` $rest 999 }}

      {{ if gt (len $tables) 0 }}
        {{ range $tables }}
          {{ $t := . }}

          {{/* Section heading from data-test */}}
          {{ $m := findRE `data-test="([^"]+)"` $t 1 }}
          {{ $key := "" }}
          {{ if gt (len $m) 0 }}
            {{ $key = replaceRE `^data-test="([^"]+)".*$` `$1` (index $m 0) }}
          {{ end }}

          {{ if $key }}
            <h2>{{ i18n (printf "data_section_%s" $key) }}</h2>
          {{ end }}

          {{/* Translate column headers: <th data-col="x"></th> */}}
          {{ $colKeys := findRE `data-col="([^"]+)"` $t 999 }}
          {{ $colSeen := dict }}
          {{ range $colKeys }}
            {{ $ck := replaceRE `^data-col="([^"]+)".*$` `$1` . }}
            {{ if not (index $colSeen $ck) }}
              {{ $colSeen = merge $colSeen (dict $ck true) }}
              {{ $from := printf `<th data-col="%s"></th>` $ck }}
              {{ $to := printf `<th>%s</th>` (i18n (printf "data_col_%s" $ck)) }}
              {{ $t = replaceRE $from $to $t }}
            {{ end }}
          {{ end }}

          {{/* Translate metric labels: <td data-metric="x"></td> */}}
          {{ $metricKeys := findRE `data-metric="([^"]+)"` $t 999 }}
          {{ $metricSeen := dict }}
          {{ range $metricKeys }}
            {{ $mk := replaceRE `^data-metric="([^"]+)".*$` `$1` . }}
            {{ if not (index $metricSeen $mk) }}
              {{ $metricSeen = merge $metricSeen (dict $mk true) }}
              {{ $from := printf `<td data-metric="%s"></td>` $mk }}
              {{ $to := printf `<td>%s</td>` (i18n (printf "data_metric_%s" $mk)) }}
              {{ $t = replaceRE $from $to $t }}
            {{ end }}
          {{ end }}

          {{ $t | safeHTML }}
        {{ end }}
      {{ else }}
        {{ $rest | safeHTML }}
      {{ end }}

    {{ else }}

      {{ .Content }}

    {{ end }}

  </section>

  <footer class="meta">
    {{ with .Lastmod }}
      <p class="small muted">{{ i18n "data_last_updated" }}: {{ .Format "2006-01-02" }}</p>
    {{ end }}
  </footer>

</article>

{{ end }}