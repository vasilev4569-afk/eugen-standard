{{ define "main" }}

{{- /* i18n strings for JS (avoid escaping issues) */ -}}
{{- $t_title_rw := i18n "calc_title_rw" -}}
{{- $t_title_r  := i18n "calc_title_r" -}}
{{- $t_write_size := i18n "calc_write_size" -}}
{{- $t_read_size  := i18n "calc_read_size" -}}
{{- $t_speed_sust := i18n "calc_th_speed_sustained" -}}
{{- $t_speed_seq  := i18n "calc_th_speed_sequential" -}}

{{- $t_no_data := i18n "calc_no_data" -}}
{{- $t_loading_data := i18n "calc_loading_data" -}}
{{- $t_reading_json := i18n "calc_reading_json" -}}
{{- $t_data_load_error := i18n "calc_data_load_error" -}}

{{- $t_summary_best := i18n "calc_summary_best" -}}   {{/* placeholders: {size}, {name}, {time} */}}
{{- $t_summary_worst := i18n "calc_summary_worst" -}} {{/* placeholders: {name}, {time}, {diff} */}}

{{- $t_range_line := i18n "calc_range_line" -}}       {{/* placeholders: {max}, {val} */}}

<div class="calc-page">
  <h1 class="calc-title" id="pageTitleH1">{{ i18n "calc_title_rw" }}</h1>

  <div class="calc-card">
    <div class="calc-controls">
      <div class="calc-left">
        <label class="calc-label" id="sizeFieldLabel">{{ i18n "calc_write_size" }}</label>
        <div class="calc-sizeRow">
          <input class="calc-number" type="number" id="sizeInput" value="10" min="1" step="1" />
          <input class="calc-range" type="range" id="sizeRange" value="10" min="1" step="1" />
        </div>
        <div class="calc-muted calc-tabnums" id="rangeLine">{{ i18n "calc_range_line_default" }}</div>
      </div>

      <div class="calc-right">
        <div class="calc-modeBlock">
          <div class="calc-label" id="modeLabel">{{ i18n "calc_mode" }}</div>
          <div class="calc-modeSwitch">
            <button class="calc-modeBtn active" id="modeWriteBtn" type="button">{{ i18n "calc_write" }}</button>
            <button class="calc-modeBtn" id="modeReadBtn" type="button">{{ i18n "calc_read" }}</button>
          </div>
        </div>
      </div>
    </div>

    <div class="calc-divider"></div>

    <div class="calc-canvasWrap">
      <canvas id="chart" class="calc-canvas" height="320"></canvas>
      <div class="calc-legend">
        <span class="calc-legendWrite">
          <span class="calc-dot calc-dot-slc"></span><span id="legendSlc">SLC</span>
        </span>
        <span class="calc-legendWrite">
          <span class="calc-dot calc-dot-sus"></span><span id="legendSus">{{ i18n "calc_legend_sustained" }}</span>
        </span>
        <span class="calc-legendRead" style="display:none;">
          <span class="calc-dot calc-dot-sus"></span><span id="legendSeq">{{ i18n "calc_legend_sequential" }}</span>
        </span>
      </div>
    </div>

    <div class="calc-out">
      <div class="calc-big calc-tabnums" id="summary">{{ i18n "calc_loading_data" }}</div>
      <div class="calc-muted calc-tabnums" id="details">{{ i18n "calc_reading_json" }}</div>
    </div>

    <div class="calc-divider"></div>

    <div class="calc-tableWrap" id="tableWrap">
      <table class="calc-table" aria-label="Calculator table">
        <thead>
          <tr>
            <th id="thNum" style="width:56px;">#</th>
            <th id="thModel" style="width:360px;">{{ i18n "calc_th_model" }}</th>

            <th id="thSlcSpeed" class="calc-rightTxt calc-col-write">{{ i18n "calc_th_slc_speed" }}</th>
            <th id="thSlcSize" class="calc-rightTxt calc-col-write">{{ i18n "calc_th_slc_size" }}</th>

            <th id="thSpeed" class="calc-rightTxt">{{ i18n "calc_th_speed_sustained" }}</th>

            <th id="thSlcPart" class="calc-rightTxt calc-col-write">{{ i18n "calc_th_slc_part" }}</th>
            <th id="thSusPart" class="calc-rightTxt calc-col-write">{{ i18n "calc_th_sus_part" }}</th>

            <th id="thTotalTime" class="calc-rightTxt calc-col-time">{{ i18n "calc_th_total_time" }}</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="calc-muted">{{ i18n "calc_loading_row" }}</td></tr>
        </tbody>
      </table>
    </div>

    <div class="calc-footNote calc-muted" id="footNote" style="margin-top:10px;">
      {{ i18n "calc_show_all" }} <span class="calc-tabnums" id="shownAllCount">—</span>
    </div>
  </div>
</div>

<style>
.calc-page{ max-width:1200px; margin:0 auto; }
.calc-title{ margin:10px 0 14px; }

.calc-card{
  border:1px solid var(--border,#e5e7eb);
  border-radius:16px;
  padding:16px;
  background:#fff;
  box-shadow:0 1px 10px rgba(0,0,0,.04);
}

.calc-controls{
  display:grid;
  grid-template-columns: 1fr 340px;
  gap:12px;
  align-items:end;
}
@media (max-width: 980px){
  .calc-controls{ grid-template-columns:1fr; }
}

.calc-label{ display:block; font-size:13px; color:#374151; margin-bottom:6px; }
.calc-sizeRow{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.calc-number{
  max-width:120px;
  width:120px;
  padding:10px 12px;
  border:1px solid #d1d5db;
  border-radius:12px;
  font-size:14px;
}
.calc-range{ flex:1; min-width:240px; }
.calc-muted{ color:#6b7280; font-size:13px; line-height:1.35; }
.calc-tabnums{ font-variant-numeric: tabular-nums; font-feature-settings:"tnum" 1,"lnum" 1; }

.calc-right{ display:grid; gap:10px; }

.calc-modeBlock{
  border:1px solid #e5e7eb;
  border-radius:14px;
  padding:10px 10px;
}
.calc-modeSwitch{ display:flex; gap:8px; }
.calc-modeBtn{
  flex:1;
  padding:10px 12px;
  border:1px solid #d1d5db;
  background:#fff;
  border-radius:12px;
  cursor:pointer;
  font-size:14px;
}
.calc-modeBtn:hover{ background:#f9fafb; }
.calc-modeBtn.active{
  border-color:#3b82f6;
  box-shadow:0 0 0 2px rgba(59,130,246,.25);
}

.calc-divider{ height:1px; background:#e5e7eb; margin:14px 0; }

.calc-canvas{
  width:100%;
  height:320px;
  border:1px solid #e5e7eb;
  border-radius:12px;
  background:#fff;
  display:block;
}
.calc-legend{ display:flex; gap:16px; margin-top:10px; flex-wrap:wrap; }
.calc-dot{ width:10px; height:10px; border-radius:999px; display:inline-block; margin-right:6px; vertical-align:middle; }
.calc-dot-slc{ background:#60a5fa; }
.calc-dot-sus{ background:#3b82f6; }

.calc-out{
  margin-top:12px;
  padding:12px;
  background:#f9fafb;
  border:1px solid #e5e7eb;
  border-radius:12px;
}
.calc-big{ font-size:18px; font-weight:800; line-height:1.2; }

.calc-tableWrap{
  overflow:auto;
  border:1px solid #e5e7eb;
  border-radius:12px;
}
.calc-table{
  width:100%;
  border-collapse:separate;
  border-spacing:0;
  min-width:980px;
  background:#fff;
}
.calc-table thead th{
  position:sticky; top:0;
  background:#fff;
  z-index:1;
  text-align:left;
  font-size:12px;
  color:#374151;
  border-bottom:1px solid #e5e7eb;
  padding:10px 12px;
  white-space:nowrap;
}
.calc-table thead th.calc-rightTxt{ text-align:right; }

.calc-table tbody td{
  border-bottom:1px solid #e5e7eb;
  padding:10px 12px;
  vertical-align:middle;
  font-size:14px;
}
.calc-rightTxt{ text-align:right; }
.calc-col-time{ width:150px; min-width:150px; white-space:nowrap; }
.calc-bestRow{ background:#fef9c3; }

.calc-col-write{ display:table-cell; }
.calc-mode-read .calc-col-write{ display:none; }

@media (max-width: 520px){
  .calc-number{ width:100%; max-width:100%; }
  .calc-range{ min-width:100%; }
}
</style>

<script>
(() => {
  const el = (id) => document.getElementById(id);

  const pageTitleH1 = el("pageTitleH1");
  const sizeFieldLabel = el("sizeFieldLabel");
  const sizeInput = el("sizeInput");
  const sizeRange = el("sizeRange");
  const rangeLine = el("rangeLine");

  const modeWriteBtn = el("modeWriteBtn");
  const modeReadBtn = el("modeReadBtn");

  const summary = el("summary");
  const details = el("details");
  const tbody = el("tbody");
  const shownAllCount = el("shownAllCount");

  const thSpeed = el("thSpeed");

  const chart = el("chart");
  const ctx = chart.getContext("2d");

  // i18n strings injected by Hugo (IMPORTANT: single jsonify, plus safeJS)
  const I18N = {
    title_rw: {{ $t_title_rw | jsonify | safeJS }},
    title_r:  {{ $t_title_r  | jsonify | safeJS }},
    write_size: {{ $t_write_size | jsonify | safeJS }},
    read_size:  {{ $t_read_size  | jsonify | safeJS }},
    speed_sustained: {{ $t_speed_sust | jsonify | safeJS }},
    speed_sequential: {{ $t_speed_seq | jsonify | safeJS }},

    no_data: {{ $t_no_data | jsonify | safeJS }},
    loading_data: {{ $t_loading_data | jsonify | safeJS }},
    reading_json: {{ $t_reading_json | jsonify | safeJS }},
    data_load_error: {{ $t_data_load_error | jsonify | safeJS }},

    summary_best: {{ $t_summary_best | jsonify | safeJS }},
    summary_worst: {{ $t_summary_worst | jsonify | safeJS }},
    range_line: {{ $t_range_line | jsonify | safeJS }},
  };

  function tpl(s, vars){
    return String(s || "").replace(/\{(\w+)\}/g, (_, k) => (vars && k in vars) ? String(vars[k]) : "");
  }

  // speeds in your json are MB/s (actually MiB/s style), and we use GiB in UI.
  const MiB_PER_GiB = 1024;

  let MODE = "write";
  let MODELS = [];
  let capacityMaxGiB = 0;

  function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

  function humanTime(sec){
    sec = Math.max(0, Math.round(sec));
    const h = Math.floor(sec/3600);
    const m = Math.floor((sec%3600)/60);
    const s = sec%60;
    if (h > 0) return `${h} h ${m} min ${s} sec`;
    if (m > 0) return `${m} min ${s} sec`;
    return `${s} sec`;
  }

  function toNum(v){
    const n = Number(v);
    return Number.isFinite(n) ? n : 0;
  }

  // "1TB", "2TB", "500GB" -> GiB (decimal -> GiB)
  function toGiBFromLabel(label){
    const s = String(label || "").trim().toUpperCase();
    if (!s) return 0;
    const m = s.match(/^(\d+(?:[.,]\d+)?)\s*(TB|GB|GIB|TIB)$/i);
    if (!m) return 0;

    const num = Number(m[1].replace(",", "."));
    const unit = m[2].toUpperCase();
    if (!Number.isFinite(num) || num <= 0) return 0;

    if (unit === "GIB") return num;
    if (unit === "TIB") return num * 1024;

    const BYTES_PER_GIB = 1024 * 1024 * 1024;
    if (unit === "GB") return (num * 1e9) / BYTES_PER_GIB;
    if (unit === "TB") return (num * 1e12) / BYTES_PER_GIB;
    return 0;
  }

  // Map ANY of your json shapes into the fields calculator uses.
  function normalizeModel(raw){
    const m = raw && typeof raw === "object" ? raw : {};

    // Accept both snake_case and camelCase variants
    const slc_speed = toNum(m.slc_speed ?? m.slcSpeed);
    const slc_gib   = toNum(m.slc_gib ?? m.slcGiB ?? m.slc_size_gib ?? m.slcSizeGiB);
    const sus_speed = toNum(m.sus_speed ?? m.sustained_speed ?? m.sustainedSpeed);
    const seq_speed = toNum(m.seq_speed ?? m.read_speed ?? m.readSpeed); // for Read mode

    // capacity: try numeric field, then capacity_label like "1TB"
    const cap =
      toNum(m.capacity_gib ?? m.capacityGiB) ||
      toGiBFromLabel(m.capacity_label ?? m.capacityLabel) ||
      toGiBFromLabel(m.capacity_slug ?? m.capacitySlug);

    return {
      id: m.id || m.model_id || "",
      name: m.name || "Unknown model",

      // normalized numeric fields used below
      capacity_gib: cap,
      slc_speed,
      slc_gib,
      sus_speed,
      seq_speed
    };
  }

  function computeMaxGiB(models){
    // Slider max should be NOT larger than smallest drive in the dataset
    let minCap = Infinity;
    for (const m of models){
      const cap = toNum(m.capacity_gib);
      if (cap > 0) minCap = Math.min(minCap, cap);
    }
    if (!Number.isFinite(minCap)) return 1000;
    return Math.max(1, Math.floor(minCap));
  }

  function updateRangeLine(){
    const max = capacityMaxGiB || Number(sizeRange.max || 2000);
    const val = Number(sizeInput.value || 0);
    rangeLine.textContent = tpl(I18N.range_line, { max, val });
  }

  function applyModeUI(){
    if (MODE === "write"){
      modeWriteBtn.classList.add("active");
      modeReadBtn.classList.remove("active");
      sizeFieldLabel.textContent = I18N.write_size;
      pageTitleH1.textContent = I18N.title_rw;
      thSpeed.textContent = I18N.speed_sustained;

      document.querySelectorAll(".calc-legendWrite").forEach(x => x.style.display = "");
      document.querySelectorAll(".calc-legendRead").forEach(x => x.style.display = "none");
      document.querySelector(".calc-card").classList.remove("calc-mode-read");
    } else {
      modeReadBtn.classList.add("active");
      modeWriteBtn.classList.remove("active");
      sizeFieldLabel.textContent = I18N.read_size;
      pageTitleH1.textContent = I18N.title_r;
      thSpeed.textContent = I18N.speed_sequential;

      document.querySelectorAll(".calc-legendWrite").forEach(x => x.style.display = "none");
      document.querySelectorAll(".calc-legendRead").forEach(x => x.style.display = "");
      document.querySelector(".calc-card").classList.add("calc-mode-read");
    }
  }

  function calcWriteParts(sizeGiB, m){
    const slcGiB = toNum(m.slc_gib);
    const slcSpeed = toNum(m.slc_speed);
    const susSpeed = toNum(m.sus_speed);

    const slcPartGiB = Math.min(sizeGiB, slcGiB);
    const susPartGiB = Math.max(0, sizeGiB - slcPartGiB);

    const slcSec = slcSpeed > 0 ? (slcPartGiB * MiB_PER_GiB) / slcSpeed : Infinity;
    const susSec = susSpeed > 0 ? (susPartGiB * MiB_PER_GiB) / susSpeed : Infinity;

    return { slcPartGiB, susPartGiB, slcSec, susSec, totalSec: slcSec + susSec };
  }

  function calcReadSeconds(sizeGiB, m){
    const seqSpeed = toNum(m.seq_speed);
    return seqSpeed > 0 ? (sizeGiB * MiB_PER_GiB) / seqSpeed : Infinity;
  }

  function sortByTime(list, sizeGiB){
    const arr = list.slice().map(m => {
      if (MODE === "write"){
        const p = calcWriteParts(sizeGiB, m);
        return { m, seconds: p.totalSec, slcSec: p.slcSec, susSec: p.susSec };
      } else {
        const sec = calcReadSeconds(sizeGiB, m);
        return { m, seconds: sec, slcSec: 0, susSec: sec };
      }
    });
    arr.sort((a,b) => a.seconds - b.seconds);
    return arr;
  }

  function drawChart(sorted){
    const dpr = window.devicePixelRatio || 1;
    const cssW = chart.clientWidth;
    const cssH = 320;
    chart.width = Math.floor(cssW * dpr);
    chart.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

    ctx.clearRect(0,0,cssW,cssH);
    if (!sorted.length) return;

    const padL = 220;
    const padR = 110;
    const padT = 18;
    const padB = 18;

    const innerW = Math.max(10, cssW - padL - padR);
    const innerH = Math.max(10, cssH - padT - padB);

    const rows = sorted.slice(0, 12);
    const rowH = innerH / rows.length;
    const barH = Math.max(10, rowH * 0.48);

    const maxSec = Math.max(...rows.map(x => x.seconds));

    ctx.strokeStyle = "#eef2f7";
    ctx.lineWidth = 1;
    const gridN = 6;
    for (let i=1; i<=gridN; i++){
      const x = padL + (innerW * i/gridN);
      ctx.beginPath();
      ctx.moveTo(x, padT);
      ctx.lineTo(x, padT + innerH);
      ctx.stroke();
    }

    rows.forEach((row, idx) => {
      const yCenter = padT + rowH*idx + rowH/2;
      const y = yCenter - barH/2;

      const frac = maxSec > 0 ? (row.seconds / maxSec) : 0;
      const totalW = innerW * frac;

      ctx.fillStyle = "#111827";
      ctx.font = "14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(`${idx+1}. ${row.m.name}`, 12, yCenter + 5);

      if (MODE === "write"){
        const slcFrac = row.seconds > 0 ? (row.slcSec / row.seconds) : 0;
        const slcW = totalW * slcFrac;
        const susW = Math.max(0, totalW - slcW);

        ctx.fillStyle = "#60a5fa";
        ctx.fillRect(padL, y, slcW, barH);

        ctx.fillStyle = "#3b82f6";
        ctx.fillRect(padL + slcW, y, susW, barH);

        ctx.strokeStyle = "#e5e7eb";
        ctx.lineWidth = 1;
        ctx.strokeRect(padL, y, totalW, barH);
      } else {
        ctx.fillStyle = "#3b82f6";
        ctx.fillRect(padL, y, totalW, barH);
      }

      ctx.fillStyle = "#111827";
      ctx.font = "700 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(humanTime(row.seconds), padL + innerW + 16, yCenter + 5);
    });

    ctx.strokeStyle = "#e5e7eb";
    ctx.lineWidth = 1;
    ctx.strokeRect(padL, padT, innerW, innerH);
  }

  function render(){
    if (!MODELS.length){
      summary.textContent = I18N.no_data;
      details.textContent = I18N.reading_json;
      tbody.innerHTML = `<tr><td colspan="8" class="calc-muted">${I18N.no_data}</td></tr>`;
      drawChart([]);
      shownAllCount.textContent = "0";
      return;
    }

    const sizeGiB = clamp(Number(sizeInput.value || 0), 0, capacityMaxGiB || 2000);

    const sorted = sortByTime(MODELS, sizeGiB);
    const best = sorted[0];
    const worst = sorted[sorted.length - 1];

    summary.textContent = tpl(I18N.summary_best, {
      size: sizeGiB,
      name: best.m.name,
      time: humanTime(best.seconds),
    });

    details.textContent = tpl(I18N.summary_worst, {
      name: worst.m.name,
      time: humanTime(worst.seconds),
      diff: humanTime(worst.seconds - best.seconds),
    });

    drawChart(sorted);

    const rowsHtml = [];
    sorted.forEach((row, idx) => {
      const m = row.m;
      const time = row.seconds;

      const slcSpeed = toNum(m.slc_speed);
      const slcGiB = toNum(m.slc_gib);
      const susSpeed = toNum(m.sus_speed);
      const seqSpeed = toNum(m.seq_speed);

      const slcPart = Math.min(sizeGiB, slcGiB);
      const susPart = Math.max(0, sizeGiB - slcPart);

      const speedVal = (MODE === "write") ? susSpeed : seqSpeed;

      const isBest = idx === 0;
      rowsHtml.push(`
        <tr class="${isBest ? "calc-bestRow" : ""}">
          <td class="calc-tabnums">${idx+1}</td>
          <td><strong>${m.name}</strong></td>

          <td class="calc-rightTxt calc-tabnums calc-col-write">${slcSpeed ? `${Math.round(slcSpeed)} MB/s` : "—"}</td>
          <td class="calc-rightTxt calc-tabnums calc-col-write">${slcGiB ? `${Math.round(slcGiB)} GiB` : "—"}</td>

          <td class="calc-rightTxt calc-tabnums">${speedVal ? `${Math.round(speedVal)} MB/s` : "—"}</td>

          <td class="calc-rightTxt calc-tabnums calc-col-write">${slcPart ? `${Math.round(slcPart)} GiB` : "0 GiB"}</td>
          <td class="calc-rightTxt calc-tabnums calc-col-write">${susPart ? `${Math.round(susPart)} GiB` : "0 GiB"}</td>

          <td class="calc-rightTxt calc-tabnums calc-col-time"><strong>${humanTime(time)}</strong></td>
        </tr>
      `);
    });

    tbody.innerHTML = rowsHtml.join("");
    shownAllCount.textContent = String(sorted.length);
    updateRangeLine();
  }

  async function loadData(){
    summary.textContent = I18N.loading_data;
    details.textContent = I18N.reading_json;
    tbody.innerHTML = `<tr><td colspan="8" class="calc-muted">${I18N.loading_data}</td></tr>`;

    try {
      const res = await fetch(`/data/calculator.json`, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();

      const rawArr = Array.isArray(data) ? data : [];
      MODELS = rawArr.map(normalizeModel).filter(m => m && m.name);

      capacityMaxGiB = computeMaxGiB(MODELS);
      sizeRange.max = String(capacityMaxGiB || 2000);
      sizeInput.max = String(capacityMaxGiB || 2000);

      const current = clamp(Number(sizeInput.value || 10), 1, capacityMaxGiB || 2000);
      sizeInput.value = String(current);
      sizeRange.value = String(current);

      updateRangeLine();
      render();
    } catch (e){
      console.error(e);
      summary.textContent = I18N.data_load_error;
      details.textContent = String(e);
      tbody.innerHTML = `<tr><td colspan="8" class="calc-muted">${I18N.data_load_error}: ${String(e)}</td></tr>`;
      MODELS = [];
      capacityMaxGiB = 0;
      shownAllCount.textContent = "—";
    }
  }

  sizeInput.addEventListener("input", () => {
    const v = Number(sizeInput.value || 0);
    sizeRange.value = String(v);
    render();
  });

  sizeRange.addEventListener("input", () => {
    const v = Number(sizeRange.value || 0);
    sizeInput.value = String(v);
    render();
  });

  modeWriteBtn.addEventListener("click", () => {
    MODE = "write";
    applyModeUI();
    updateRangeLine();
    render();
  });

  modeReadBtn.addEventListener("click", () => {
    MODE = "read";
    applyModeUI();
    updateRangeLine();
    render();
  });

  window.addEventListener("resize", () => render());

  applyModeUI();
  loadData();
})();
</script>

{{ end }}