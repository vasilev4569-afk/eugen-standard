<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>CMS Auth Callback</title>
    <meta name="robots" content="noindex,nofollow" />
  </head>
  <body>
    <script>
      (async () => {
        try {
          const params = new URLSearchParams(window.location.search);
          const code = params.get("code");
          if (!code) throw new Error("No code in callback URL");

          const tokenRes = await fetch(
            "https://eugen.vasilev4569.workers.dev/token?code=" + encodeURIComponent(code),
            { headers: { "Accept": "application/json" } }
          );

          const tokenData = await tokenRes.json();
          if (!tokenData.access_token) {
            throw new Error("No access_token. " + JSON.stringify(tokenData));
          }

          window.opener.postMessage(
            `authorization:github:success:${JSON.stringify({
              token: tokenData.access_token,
              provider: "github",
            })}`,
            window.location.origin
          );

          window.close();
        } catch (e) {
          document.body.innerText =
            "Auth error: " + (e && e.message ? e.message : String(e));
        }
      })();
    </script>
  </body>
</html>
